<!DOCTYPE html>
<!--suppress ALL -->
<html lang="en" xmlns:v-on="http://www.w3.org/1999/xhtml" xmlns:v-bind="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>QueryVis</title>
    <link rel="icon" href="/static/favicon.png" type="image/x-png">
    <link rel="stylesheet" href="/static/spectre.min.css" type="text/css">
    <link rel="stylesheet" href="/static/spectre-icons.min.css" type="text/css">
    <link rel="stylesheet" href="/static/spectre-exp.min.css" type="text/css">
    <link rel="stylesheet" href="/static/vis.min.css" type="text/css">
    <link rel="stylesheet" href="/static/vue-multiselect.min.css" type="text/css">
    <link rel="stylesheet" href="/static/logtail.css" type="text/css">
    <link rel="stylesheet" href="/static/searchrefiner.css" type="text/css">
    <style>
        body, html, .container {
            height: 100%;
            max-height: 100%;
            overflow: hidden;
        }

        #tree {
            height: calc(100% - 36px);
        }

        #tree-wrapper {
            background-color: #f9f9f9;
            height: 100%;
        }

        textarea {
            padding: 0;
            margin: 0;
        }

        .tab-block {
            margin: 0;
        }

        .panel-header, .panel-body, .panel-footer {
            padding: 0 !important;
        }

        .panel {
            padding-left: 12px !important;
        }

        #console {
            margin: 0;
            overflow-y: scroll;
            height: 100%;
            background-color: #1c1c1c;
            color: #f9f9f9;
            font-size: 12px;
        }

        #tree-stats {
            position: absolute;
            top: 32px;
            right: 8px;
            background-color: #ffffff;
            padding: 8px;
            z-index: 99999999999;
            border: 1px solid #1c1c1c;
        }

        .vis-button {
            -webkit-border-radius: 0 !important;
            -moz-border-radius: 0 !important;
            border-radius: 0 !important;
            background-position: 0 0 !important;
            background-size: contain;
        }

        .vis-up, .vis-down, .vis-left, .vis-right {
            display: none !important;
        }

        .vis-zoomExtends {
            bottom: 90px !important;
        }

        .vis-zoomOut {
            bottom: 10px !important;
            right: 15px !important;
        }

        .vis-zoomIn {
            bottom: 46px !important;
        }

        .text-sm {
            line-height: 0.9rem;
        }

        .span-sm,
        .a-sm {
            font-size: 10px;
            line-height: 0.0rem;
        }

        .author-sm {
            line-height: 0.0rem;
            font-size: 12px;
            margin: 0 0 0 0;
            padding: 0;
            text-align: left;
        }

        .author-sm:after {
            content: ",";
            margin-right: 6px;
        }

        .a-sm:after {
            content: ';';
            margin-right: 6px;
        }

        .author-sm:last-child:after,
        .a-sm:last-child:after {
            content: none;
        }

        /* Thanks to https://cn.vuejs.org/v2/examples/modal.html */
        .modal-mask {
            overflow: auto;
            position: fixed;
            z-index: 9998;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, .5);
            opacity: 1;
            display: table;
            transition: opacity .3s ease;
        }

        .modal-wrapper {
            overflow: auto;
            display: table-cell;
            vertical-align: middle;
        }

        .modal-container {
            max-width: 100%;
            overflow: auto;
            margin: 0px auto;
            padding: 20px 30px;
            background-color: #fff;
            opacity: 1;
            border-radius: 2px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, .33);
            transition: all .3s ease;
            font-family: Helvetica, Arial, sans-serif;
        }

        .modal-body {
            overflow: auto;
            margin: 20px 0;
        }

        .modal-default-button {
            line-height: 12px;
            width: 8%;
            font-size: 12pt;
            font-family: tahoma;
            margin-top: 1px;
            margin-right: 2px;
            position: relative;
            top: 0;
            right: 0;
            float: right;
        }

        .modal-enter {
            opacity: 0.8;
        }

        .modal-leave-active {
            opacity: 0.3;
        }

        .modal-enter .modal-container,
        .modal-leave-active .modal-container {
            -webkit-transform: scale(0.1);
            transform: scale(0.1);
        }
    </style>
</head>
<body>
<script type="text/javascript" src="/static/bigbro.js"></script>
<script type="text/javascript">
    let bb = BigBro.init({{.UID}}, window.location.host + "/plugin/iuserstudy?bigbro");
    window.addEventListener("load", function (e) {
        bb.log(e, "pageload", "{{.UID}}")
    })
</script>
<div class="container" id="app">
    <header class="navbar bg-secondary nav-height">
        <section class="navbar-section"><a href="?uid={{.UID}}"><i class="icon icon-arrow-left"></i>back</a></section>
        <section class="navbar-section">Participant ID:<span class="label label-primary mr-1 ml-1">{{.UID}}</span></section>
    </header>
    <div class="columns" style="height: calc(100%);">
        <div class="column col-6" style="padding-left: 20px !important; height: calc(100% - 36px);overflow-y: scroll">
            <div class="form-group">
                <pre name="query" class="code" id="qvis-text-query-box">[[ textQuery ]]</pre>
                <input type="hidden" name="lang" value="pubmed" id="qvis-lang-input">
            </div>
            {{/*<a href="#">Edit</a>*/}}
            <div class="panel p-2">
                <div class="panel-header">
                    <b>Query Builder</b>
                </div>
                <div class="panel-body" style="overflow: hidden;">
                    <builder id="qvis-query-builder" v-for="(query, index) in queries"
                             :key="query.id"
                             v-on:add="addQuery"
                             v-on:remove="removeQuery"
                             v-bind:query="query"
                             v-bind:index="index"
                             v-bind:last="index==queries.length-1"></builder>
                    <a href="#" v-on:click="clear" id="qvis-clear-query-builder">Clear</a>
                </div>
                <div class="panel-footer">
                    <button class="btn btn-primary nav-height" id="qvis-load-results-update-tree-btn" v-on:click="updateTree">
                        <i class="icon icon-forward"></i> Search
                    </button>
                    <div class="divider"></div>
                    <p>Use the query builder above to formulate your query. Click the back link in the top left corner of the interface to return to the study.</p>
                </div>
            </div>
            <div class="panel p-2 mt-2">
                <div class="panel-header">
                    <ul class="tab tab-block">
                        <li class="tab-item" v-bind:class="{active: tabState==='results'}" v-on:click="tabState='results'">
                            <a href="#" id="qvis-result-tab" class="badge" v-bind:data-badge="total">Results</a>
                        </li>
                        <li class="tab-item" v-bind:class="{active: tabState==='history'}" v-on:click="tabState='history'">
                            <a href="#">History</a>
                        </li>
                        <li class="tab-item" v-bind:class="{active: tabState==='seed'}" v-on:click="tabState='seed'">
                            <a href="#" id="qvis-history-tab">Seed Documents</a>
                        </li>
                        <li class="tab-item" v-bind:class="{active: tabState==='criteria'}" v-on:click="tabState='criteria'">
                            <a href="#" id="qvis-criteria-tab">Search Criteria</a>
                        </li>
                        <li class="tab-item" v-bind:class="{active: tabState==='mesh'}" v-on:click="tabState='mesh';meshSearchBoxFocus()">
                            <a href="#" id="qvis-mesh-tab">MeSH Browser</a>
                        </li>
                    </ul>
                </div>
                <div class="panel-body container" v-show="tabState==='history'">
                    <div class="columns">
                        <div class="column col-6 text-italic">Query</div>
                        <div class="column col-2 text-italic">Items found</div>
                        <div class="column col-2 text-italic">Relevant items found</div>
                        <div class="column col-1 text-italic">Add to Search</div>
                    </div>
                    <div class="divider"></div>
                    <div v-for="(query, i) in history">
                        <div class="columns">
                            <div class="column col-6" id="qvis-query-string">[[ query.QueryString ]]</div>
                            <div class="column col-2" id="qvis-query-numret">[[ query.NumRet ]]</div>
                            <div class="column col-2" id="qvis-query-numrelret">[[ query.NumRelRet ]]</div>
                            <div class="column col-1" id="pub-query-numret"><a href="#" class="btn btn-primary" v-on:click="addFromHistory(i)">add</a></div>
                        </div>
                        <div class="divider"></div>
                    </div>
                </div>
                <div class="panel-body container" v-show="tabState==='results'" style="overflow: hidden">
                    <div v-if="busy && !ready" class="loading loading-lg"></div>
                    <p v-if="!init">Results will show here once you click the search button above.</p>
                    <ol v-infinite-scroll="loadNextResults" infinite-scroll-disabled="busy" infinite-scroll-distance="10">
                        <li v-for="c in results" class="pb-2">
                            <a href="#/" id="qvis-results-item" v-on:click="loadResultDocument(c.PMID)">[[c.TI]]</a>
                            <!-- Thanks to https://cn.vuejs.org/v2/examples/modal.html-->
                            <modal id="qvis-results-modal" v-if="showModal" v-on:close="showModal = false">
                                <h3 slot="header" id="qvis-result-modal-doc-title">[[ document.title ]]</h3>
                                <h5 slot="header" id="qvis-result-modal-doc-title" v-show="!document.title">Cannot load results. Try again later. [[document.pmid]]</h5>
                                <span slot="header" id="qvis-result-modal-doc-pmid" class="span-sm"><strong>PMID</strong>: [[ document.pmid ]]</span>
                                <br slot="header">
                                <span slot="header" id="qvis-result-modal-doc-name" class="span-sm" v-if="document.type == 'book'"><strong>Book</strong>: [[ document.book ]]</span>
                                <span slot="header" id="qvis-result-modal-doc-name" class="span-sm" v-if="document.type == 'article'"><strong>Journal</strong>: [[ document.journal ]]</span>
                                <br slot="header">
                                <span slot="header" id="qvis-result-modal-doc-pubdate" class="span-sm" v-if="document.pubdate != null"><strong>Publication Date</strong>: [[ document.pubdate ]]</span>
                                <div slot="body" class="divider"></div>
                                <h5 slot="body"><strong>Abstract:</strong></h5>
                                <ul style="list-style-type: none;" slot="body">
                                    <li class="span-rg" v-for="field in document.abstract">
                                        <span id="qvis-result-modal-doc-abs" class="span-rg" v-if="field.field != ''"><strong>[[ field.field ]]</strong>: [[ field.content ]]</span>
                                        <span id="qvis-result-modal-doc-abs" class="span-rg" v-if="field.field == ''">[[ field.content ]]</span>
                                    </li>
                                </ul>
                                <h5 slot="body" v-if="document.type == 'article' && document.meshheadings.length > 0"><strong>Mesh Headings:</strong></h5>
                                <ul style="list-style-type: circle;" slot="body" v-if="document.type == 'article' && document.meshheadings.length > 0">
                                    <li class="span-rg" id="qvis-result-modal-doc-mesh-item" v-for="mesh in document.meshheadings">
                                        <span id="qvis-result-modal-doc-mesh" class="span-rg">[[ mesh ]]</span>
                                    </li>
                                </ul>
                            </modal>
                            <a href="#/" id="qvis-results-item" v-on:click="loadResultDocument(c.PMID)" v-show="!c.TI">[No Title] [[c.PMID]]</a>
                            <div class="text-left text-sm">
                                <!-- <a v-for="author in c.AU" class="text-success author-sm"
                                   v-bind:href="'https://www.ncbi.nlm.nih.gov/pubmed/?term=%22' + author + '%22[Author]'">[[author]]</a>&nbsp; -->
                                <span id="qvis-results-author" v-for="author in c.AU" class="text-success author-sm">[[author]]</span>&nbsp;
                            </div>
                            <div class="text-left text-sm text-gray">
                                <span id="qvis-results-pmid" class="span-sm"><strong>PMID</strong>: [[ c.PMID ]]</span>
                            </div>
                        </li>
                    </ol>
                    <div v-if="busy && ready" class="loading loading-lg"></div>
                </div>
                <div class="panel-body container" v-show="tabState==='mesh'" style="overflow:hidden;">
                    <input class="panel-body" v-show="tabState==='mesh'" style="overflow:hidden;width:100%" v-model="meshTerm" id="meshInputBox" v-on:keyup="loadMeSH" placeholder="type search terms here">
                    <div class="divider"></div>
                    <a href="#" id="qvis-reset-mesh" v-on:click="resetMeSHBrowser()">Clear All</a>
                    <div class="panel-footer">
                        <button class="btn btn-primary" id="qvis-mesh-search-btn" v-on:click="loadMeSH()">
                            <i class="icon icon-forward"></i> Search
                        </button>
                        <div class="divider"></div>
                        <p v-if="!meshInit">Use the search box above to input your term.</p>
                        <div v-if="meshBusy && !meshReady" class="loading loading-lg"></div>
                        <div class="text-left text-sm text-gray">
                            <span class="span-sm" v-if="meshInit" style="font-size:100%"> Total of <strong>[[ ids.length ]]</strong> results found (<strong>[[ timeSpend ]]</strong> seconds)</span>
                        </div>
                        <ul style="list-style-type:none">
                            <li v-if="meshInit" v-for="info in displayedMeSHInfos" class="pb-2"> [[ info.rank ]].
                                <a href="#/" id="qvis-mesh-name" v-on:click="ctrlDiv(info.id)"> [[ info.name ]] </a></br>
                                <div class="text-left text-sm">
                                    <span id="qvis-mesh-description"><strong>Description:</strong> [[ info.desc ]] </span>
                                    <span v-show="info.desc === ''"> No description</span>
                                </div>
                                <div class="text-left text-sm text-gray">
                                    <span id="qvis-mesh-year" class="span-sm" v-show="info.yIntroduced != ''"><strong>Year Introduced:</strong> [[ info.yIntroduced ]]</span>
                                    <span id="qvis-mesh-year" class="span-sm" v-show="info.supDate != '1/01/01' && info.yIntroduced === ''"><strong>Year Introduced:</strong> [[ info.supDate ]]</span>
                                    <span id="qvis-mesh-year" class="span-sm" v-show="info.yIntroduced === '' && info.supDate === '1/01/01'"><strong>Year Introduced:</strong> Not Provided </span>
                                </div>
                                <ul style="display:none" v-bind:id="info.id" class="infoBox">
                                    <li v-for="term in info.terms" id="qvis-mesh-term">
                                        [[ term ]]
                                    </li>
                                </ul>
                            </li>
                        </ul>
                        <!--Thanks to https://vuejsexamples.com/pagination-in-vuejs-simple-way/-->
                        <ul class="pagination" v-if="meshInit">
                            <li class="page-item">
                                <button id="qvis-mesh-prev-page" v-if="ids.length != 0" type="button" class="btn btn-primary" v-on:click="resetDiv('p')"> Previous</button>
                            </li>
                            <li class="page-item">
                                <button id="qvis-mesh-page" type="button" v-if="page <= totalPages" class="btn btn-primary"><input v-bind:value="page" style="width:30%;height:100%;text-align:center" v-model="uDefPage" v-on:keyup="jumpPage"/> / [[ totalPages ]]</button>
                            </li>
                            <li class="page-item">
                                <button id="qvis-mesh-next-page" v-if="ids.length != 0" type="button" v-on:click="resetDiv('n')" class="btn btn-primary"> Next</button>
                            </li>
                        </ul>
                        <div v-if="meshInit && totalPages > 0">
                            Number of MeSH Terms Per Page:
                            <input id="qvis-input-mesh-per-page" type="number" class="panel-body" v-show="tabState==='mesh'" style="overflow:hidden;width:5%" v-model="userDefPerPage" v-on:keyup="changeNumOfTermsPerPage">
                            <button class="btn btn-primary" id="qvis-change-mesh-per-page-btn" v-on:click="changeNumOfTermsPerPage()">
                                Change
                            </button>
                        </div>
                    </div>
                </div>
                <div class="panel-body container" v-if="tabState==='seed'" v-show="tabState==='seed'" style="overflow:hidden;">
                    <ol>
                        <li v-for="seed in seedDocInfos" class="pb-2">
                            <a href="#/" id="qvis-seed-item" v-on:click="loadResultDocument(seed.pmid)">[[ seed.title ]]</a>
                            <modal id="qvis-seed-modal" v-if="showModal" v-on:close="showModal = false">
                                <h3 id="qvis-seed-modal-doc-title" slot="header">[[ document.title ]]</h3>
                                <h3 id="qvis-seed-modal-doc-title" slot="header" v-show="!document.title">[No Title] [[document.pmid]]</h3>
                                <span id="qvis-seed-modal-doc-pmid" slot="header" class="span-sm"><strong>PMID</strong>: [[ document.pmid ]]</span>
                                <br slot="header">
                                <span id="qvis-seed-modal-doc-name" slot="header" class="span-sm" v-if="document.type == 'book'"><strong>Book</strong>: [[ document.book ]]</span>
                                <span id="qvis-seed-modal-doc-name" slot="header" class="span-sm" v-if="document.type == 'article'"><strong>Journal</strong>: [[ document.journal ]]</span>
                                <br slot="header">
                                <span id="qvis-seed-modal-doc-pubdate" slot="header" class="span-sm" v-if="document.pubdate != null"><strong>Publication Date</strong>: [[ document.pubdate ]]</span>
                                <div slot="body" class="divider"></div>
                                <h5 slot="body"><strong>Abstract:</strong></h5>
                                <ul style="list-style-type: none;" slot="body">
                                    <li class="span-rg" v-for="field in document.abstract">
                                        <span id="qvis-seed-modal-doc-abs" class="span-rg" v-if="field.field != ''"><strong>[[ field.field ]]</strong>: [[ field.content ]]</span>
                                        <span id="qvis-seed-modal-doc-abs" class="span-rg" v-if="field.field == ''">[[ field.content ]]</span>
                                    </li>
                                </ul>
                                <h5 slot="body" v-if="document.type == 'article' && document.meshheadings.length > 0"><strong>Mesh Headings:</strong></h5>
                                <ul style="list-style-type: circle;" slot="body" v-if="document.type == 'article' && document.meshheadings.length > 0">
                                    <li class="span-rg" v-for="mesh in document.meshheadings" id="qvis-result-modal-doc-mesh-item">
                                        <span class="span-rg" id="qvis-result-modal-doc-mesh">[[ mesh ]]</span>
                                    </li>
                                </ul>
                            </modal>
                            <a href="#/" id="qvis-seed-item" v-on:click="loadResultDocument(seed.pmid)" v-show="!seed.title">[No Title] [[seed.pmid]]</a>
                            <div class="text-left text-sm text-gray">
                                <span class="span-sm" id="qvis-seed-pmid"><strong>PMID</strong>: [[ seed.pmid ]]</span>
                            </div>
                        </li>
                    </ol>
                </div>
                <div class="panel-body container" v-show="tabState==='criteria'" id="qvis-criteria-content">
                    {{if eq .Protocol 1}}
                        {{template "protocol1"}}
                    {{else}}
                        {{template "protocol2"}}
                    {{end}}
                </div>
            </div>
        </div>
        <div class="column col-6">
            <div id="tree-stats">
                <div><strong>[[ total ]]</strong> citations retrieved</div>
                <div><strong>[[ numRel ]]</strong> citations relevant</div>
                <div><strong>[[ numRelRet ]]</strong> citations relevant retrieved</div>
            </div>
            <div id="tree-wrapper">
                <div id="tree" class="c-move"></div>
            </div>
        </div>
    </div>
</div>

<script type="text/x-template" id="builder">
    <div class="columns">
        <div class="column col-2">
            <select id="qvis-query-builder-operator-select" class="form-select select-sm" v-if="index>0" v-model="query.operator" v-bind:field="query.operator" v-on:change="updateCQR">
                <option id="qvis-query-builder-operator-and" value="and">AND</option>
                <option id="qvis-query-builder-operator-or" value="or">OR</option>
                <option id="qvis-query-builder-operator-not" value="not">NOT</option>
            </select>
        </div>
        <div class="column col-3">
            <select id="qvis-query-builder-field-select" class="form-select select-sm" v-model="query.field" v-bind:field="query.field" v-on:change="updateCQR">
                <option id="qvis-query-builder-field-affiliation" value="Affiliation">Affiliation</option>
                <option id="qvis-query-builder-field-all" value="All Fields" selected="selected">All Fields</option>
                <option id="qvis-query-builder-field-author" value="Author">Author</option>
                <option id="qvis-query-builder-field-author-corp" value="Author - Corporate">Author - Corporate</option>
                <option id="qvis-query-builder-field-author-first" value="Author - First">Author - First</option>
                <option id="qvis-query-builder-field-author-full" value="Author - Full">Author - Full</option>
                <option id="qvis-query-builder-field-author-identifier" value="Author - Identifier">Author - Identifier</option>
                <option id="qvis-query-builder-field-author-last" value="Author - Last">Author - Last</option>
                <option id="qvis-query-builder-field-book" value="Book">Book</option>
                <option id="qvis-query-builder-field-conflict-interest-state" value="Conflict of Interest Statements">Conflict of Interest Statements</option>
                <option id="qvis-query-builder-field-comp-date" value="Date - Completion">Date - Completion</option>
                <option id="qvis-query-builder-field-create-date" value="Date - Create">Date - Create</option>
                <option id="qvis-query-builder-field-entrez-date" value="Date - Entrez">Date - Entrez</option>
                <option id="qvis-query-builder-field-mesh-date" value="Date - MeSH">Date - MeSH</option>
                <option id="qvis-query-builder-field-moddate" value="Date - Modification">Date - Modification</option>
                <option id="qvis-query-builder-field-pubdate" value="Date - Publication">Date - Publication</option>
                <option id="qvis-query-builder-field-ec-rn-no" value="EC/RN Number">EC/RN Number</option>
                <option id="qvis-query-builder-field-editor" value="Editor">Editor</option>
                <option id="qvis-query-builder-field-filter" value="Filter">Filter</option>
                <option id="qvis-query-builder-field-grant-no" value="Grant Number">Grant Number</option>
                <option id="qvis-query-builder-field-isbn" value="ISBN">ISBN</option>
                <option id="qvis-query-builder-field-investigator" value="Investigator">Investigator</option>
                <option id="qvis-query-builder-field-investigator-full" value="Investigator - Full">Investigator - Full</option>
                <option id="qvis-query-builder-field-issue" value="Issue">Issue</option>
                <option id="qvis-query-builder-field-journal" value="Journal">Journal</option>
                <option id="qvis-query-builder-field-lang" value="Language">Language</option>
                <option id="qvis-query-builder-field-location-id" value="Location ID">Location ID</option>
                <option id="qvis-query-builder-field-mesh-major-topic" value="MeSH Major Topic">MeSH Major Topic</option>
                <option id="qvis-query-builder-field-mesh-subheading" value="MeSH Subheading">MeSH Subheading</option>
                <option id="qvis-query-builder-field-mesh-term" value="MeSH Terms">MeSH Terms</option>
                <option id="qvis-query-builder-field-other-term" value="Other Term">Other Term</option>
                <option id="qvis-query-builder-field-pagination" value="Pagination">Pagination</option>
                <option id="qvis-query-builder-field-pharmacological-act" value="Pharmacological Action">Pharmacological Action</option>
                <option id="qvis-query-builder-field-pub-type" value="Publication Type">Publication Type</option>
                <option id="qvis-query-builder-field-publisher" value="Publisher">Publisher</option>
                <option id="qvis-query-builder-field-sec-source-id" value="Secondary Source ID">Secondary Source ID</option>
                <option id="qvis-query-builder-field-sub-personal-name" value="Subject - Personal Name">Subject - Personal Name</option>
                <option id="qvis-query-builder-field-supp-concept" value="Supplementary Concept">Supplementary Concept</option>
                <option id="qvis-query-builder-field-text-word" value="Text Word">Text Word</option>
                <option id="qvis-query-builder-field-title" value="Title">Title</option>
                <option id="qvis-query-builder-field-title-abs" value="Title/Abstract">Title/Abstract</option>
                <option id="qvis-query-builder-field-trans-title" value="Transliterated Title">Transliterated Title</option>
                <option id="qvis-query-builder-field-volume" value="Volume">Volume</option>
            </select>
        </div>
        <div class="column col-5">
            <input id="qvis-cqr" type="text" v-model="query.query" v-bind:query="query.query" v-on:keyup="updateCQR" class="form-input input-sm"/>
        </div>
        <div class="column col-2">
            <div class="btn-group">
                <a href="#" id="qvis-remove-query-from-builder" class="btn btn-action btn-sm" v-on:click="removeSelf"><i class="icon icon-minus"></i></a>
                <a href="#" id="qvis-add-query-to-builder" class="btn btn-action btn-sm" v-if="last" v-on:click="addQuery"><i class="icon icon-plus"></i></a>
            </div>
        </div>
    </div>
</script>
<!-- template for the modal component -->
<script type="text/x-template" id="modal-template">
    <transition name="modal">
        <div class="modal-mask">
            <div class="modal-wrapper">
                <div class="modal-container">
                    <a href="#/" id="qvis-modal-close-btn" class="modal-default-button" @click="$emit('close')">
                        CLOSE
                    </a>
                    <div class="modal-header">
                        <slot name="header">
                            DEFAULT HEADER
                        </slot>
                    </div>
                    <div class="modal-body">
                        <slot name="body">
                            DEFAULT BODY
                        </slot>
                    </div>
                </div>
            </div>
        </div>
    </transition>
</script>
<!-- Main app code. -->
<script src="/static/vue.js" type="text/javascript"></script>
<script src="/static/vue-infinite-scroll.js" type="text/javascript"></script>
<script type="text/javascript" src="/static/lodash.min.js"></script>
<script src="/static/Sortable.min.js"></script>
<script src="/static/vuedraggable.min.js"></script>
<script src="/static/xml2json.js"></script>
<!--suppress JSUnusedGlobalSymbols -->
<script>
    Vue.component('modal', {
        template: '#modal-template'
    })
    var structuredID = 0;
    Vue.component("builder", {
        delimiters: ["[[", "]]"],
        template: "#builder",
        props: ["index", "last", "query"],
        data: function () {
            return {
                id: structuredID++,
            }
        },
        beforeMount: function () {
            this.updateCQR();
        },
        methods: {
            removeSelf: function () {
                this.$emit("remove", this.$props.index);
            },
            addQuery: function () {
                this.$emit("add", {query: "", fields: ["All Fields"], operator: "and", cqr: {}, field: "All Fields"})
            },
            updateCQR: _.debounce(function () {
                if (this.$props.query.query.length === 0) {
                    this.$props.query.cqr = {query: this.$props.query.query, fields: [this.$props.query.field]}
                    return
                }
                var self = this;
                var request = new XMLHttpRequest();
                request.addEventListener("load", function (ev) {
                    if (ev.currentTarget.status === 200) {
                        self.$props.query.cqr = JSON.parse(ev.currentTarget.responseText)
                        self.$props.query.cqr = fixNilFields(self.$props.query.cqr, self.$props.query.field)
                    }
                });
                request.open("POST", "/api/query2cqr");
                request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                request.send("query=" + self.query.query + "&lang=pubmed&field=" + self.query.field);
            }, 250, {'maxWait': 1000})
        }
    });

    fixNilFields = function (query, field) {
        if (query.children !== undefined && query.children.length > 0) {
            for (var i = 0; i < query.children.length; i++) {
                query.children[i] = fixNilFields(query.children[i], field)
            }
        } else if (query.fields[0] === "nil") {
            query.fields[0] = field
        }
        return query
    }

    var vm = new Vue({
        delimiters: ["[[", "]]"],
        el: "#app",
        data: {
            tabEditor: 0,
            tabVisualise: 0,
            numRet: 0,
            numRel: 0,
            numRelRet: 0,
            textQuery: "",
            textQueryDate: "",
            queryLanguage: "{{.Language}}",
            queries: [{query: "", field: "All Fields", operator: "", cqr: {}}, {query: "", field: "All Fields", operator: "and", cqr: {}}],
            history: [],
            tabState: "results",
            date: "{{.Date}}",

            // handle MeSH browser
            ids: [],
            meshInfo: [{rank: 0, id: "", name: "", desc: "", yIntroduced: "", supDate: "", terms: []}],
            meshTerm: "",
            meshInit: false,
            meshBusy: false,
            meshReady: false,

            // handle pagination
            page: 1,
            perPage: 5,
            totalPages: 0,
            userDefPerPage: 5,
            uDefPage: 1,

            // handle time spend count
            meshSearchStart: 0,
            meshSearchEnd: 0,
            timeSpend: 0,

            seed: "{{.Seed}}",
            seedDocIds: null,
            seedDocInfos: [{"pmid": null, "title": null}],

            document: {"type": null, "pmid": null, "title": null, "abstract": [], "pubdate": null, "journal": null, "book": null, "meshheadings": []},

            showModal: false,

            results: [],
            total: 0,
            busy: false,
            ready: false,
            finished: false,
            init: false,
            start: 0,
        },
        computed: {
            displayedMeSHInfos() {
                return this.paginate(this.meshInfo);
            },
            cqrQuery() {
                var q = {};
                for (var i = 0; i < this.queries.length; i++) {
                    var child = {}
                    if (!Object.keys(this.queries[i].cqr).length) {
                        child = {
                            query: this.queries[i].query,
                            fields: [this.queries[i].field],
                        }
                    } else {
                        child = this.queries[i].cqr;
                        // if (child === undefined || child.operator == "") {
                        //     child = {
                        //         query: this.queries[i].query,
                        //         fields: [this.queries[i].field],
                        //     }
                        // }
                    }

                    // Skip adding this child because it is empty.
                    if (child.operator === undefined && (child.query === null || child.query === undefined || child.query.length === 0)) {
                        continue
                    }

                    // Add the child underneath the current query.
                    if (!Object.keys(q).length) {
                        q = child
                    } else {
                        q = {
                            operator: this.queries[i].operator,
                            children: [
                                child,
                                q
                            ]
                        }
                    }
                }
                return JSON.stringify(q)
            }
        },
        methods: {
            meshSearchBoxFocus: function () {
                document.getElementById("meshInputBox").focus();
            },
            jumpPage: function (e) {
                if (e.keyCode === 13) {
                    if (this.uDefPage != this.page && this.uDefPage != '' && this.uDefPage != undefined && this.uDefPage > 0 && this.uDefPage <= this.totalPages) {
                        this.page = this.uDefPage;
                    }
                }
            },
            resetDiv: function (direction) {
                let self = this;
                var div = document.getElementsByClassName("infoBox");
                for (i = 0; i < div.length; i++) {
                    div[i].style.display = "none";
                }
                if (direction === 'p') {
                    if (self.page > 1 && self.uDefPage > 1) {
                        self.page--;
                        self.uDefPage--;
                    }
                } else if (direction === 'n') {
                    if (self.page < self.totalPages && self.uDefPage < self.totalPages) {
                        self.page++;
                        self.uDefPage++;
                    }
                }
            },
            ctrlDiv: function (id) {
                var div = document.getElementById(id);
                var divs = document.getElementsByClassName("infoBox");
                for (i = 0; i < divs.length; i++) {
                    if (divs[i].id != id) {
                        divs[i].style.display = "none";
                    }
                }
                div.style.display = div.style.display === "block" ? "none" : "block";
            },
            updateTree: function (e) {
                this.loadResults()
                var self = this
                var el = document.getElementById("qvis-load-results-update-tree-btn");
                el.classList.add("loading");

                {
                    var request = new XMLHttpRequest();
                    request.addEventListener("load", function (ev) {
                        el.classList.remove("loading");
                        var resp = JSON.parse(ev.target.responseText);
                        network.setData(resp);
                        for (var i = 0; i < resp.nodes.length; i++) {
                            if (resp.nodes[i].id == 1) {
                                self.numRet = resp.nodes[i].value
                            }
                        }
                        self.numRel = resp.NumRel;
                        self.numRelRet = resp.NumRelRet;
                    });
                    request.open("POST", "/plugin/iuserstudy?tree=y", true);
                    request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                    request.send("query=" + this.textQuery + "&lang=" + this.queryLanguage);
                }

                self.getHistory();
            },
            removeQuery: function (index) {
                this.queries.splice(index, 1)
                if (this.queries.length == 0) {
                    this.queries.push({query: ""})
                }
            },
            addQuery: function (query) {
                this.queries.push(query)
            },
            addFromHistory: function(idx) {
                var self = this;
                request = new XMLHttpRequest();
                request.addEventListener("load", function (ev) {
                    self.addQuery({"field": "All Fields", "cqr": JSON.parse(ev.target.responseText), "query": self.history[idx]["QueryString"], "operator":"and"});
                })
                request.open("POST", "/api/query2cqr", true);
                request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                request.send("query=" + this.history[idx]["QueryString"] + "&lang=pubmed");
            },
            getHistory: function () {
                var self = this;
                request = new XMLHttpRequest();
                request.addEventListener("load", function (ev) {
                    self.history = JSON.parse(ev.target.responseText);
                })
                request.open("GET", "/api/history", true);
                request.send()
            },
            updateText: _.debounce(function () {
                var self = this;
                var request = new XMLHttpRequest();
                var request1 = new XMLHttpRequest();
                request.addEventListener("load", function (ev) {
                    if (ev.currentTarget.status === 200) {
                        self.textQuery = ev.currentTarget.responseText
                    }
                });
                request.open("POST", "/api/cqr2query");
                request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                request.send("query=" + self.cqrQuery + "&lang=" + self.queryLanguage);

                var restriction = {
                    operator: "and",
                    children: [
                        JSON.parse(self.cqrQuery),
                        {
                            query: self.date,
                            fields: ["Publication Date"],
                        }
                    ]
                }
                request1.addEventListener("load", function (ev) {
                    if (ev.currentTarget.status === 200) {
                        self.textQueryDate = ev.currentTarget.responseText
                    }
                });
                request1.open("POST", "/api/cqr2query");
                request1.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                request1.send("query=" + JSON.stringify(restriction) + "&lang=" + self.queryLanguage);

            }, 250, {'maxWait': 1000}),
            clear: function () {
                this.queries = [{query: "", field: "All Fields", operator: "", cqr: {}}, {query: "", field: "All Fields", operator: "and", cqr: {}}];
            },
            loadResultDocument: function (pmid) {
                let self = this;
                var request = new XMLHttpRequest();
                request.addEventListener("load", function (ev) {
                    if (ev.currentTarget.status === 200) {
                        let resp = ev.currentTarget.responseXML;
                        var strJRes = xml2json(resp);
                        var trimmedJRes = strJRes.replace("undefined", "");
                        var jRes = JSON.parse(trimmedJRes);
                        if (!_.isUndefined(jRes.PubmedArticleSet.PubmedBookArticle)) {
                            var title = null;
                            var abstract = [];
                            var pubdate = null;
                            var book = null;
                            try {
                                title = jRes.PubmedArticleSet.PubmedBookArticle.BookDocument.ArticleTitle["#text"];
                            } catch (error) {
                                title = null;
                            }
                            var abstractFull = null;
                            try {
                                abstractFull = jRes.PubmedArticleSet.PubmedBookArticle.BookDocument.Abstract["AbstractText"];
                            } catch (error) {
                                abstractFull = null;
                            }
                            if (abstractFull != null) {
                                if (typeof (abstractFull) === "object") {
                                    for (i = 0; i < abstractFull.length; i++) {
                                        var content = abstractFull[i]["#text"];
                                        content = content.replace(/<i>/g, "");
                                        content = content.replace(/<\/i>/g, "");
                                        var field = {
                                            "field": abstractFull[i]["@Label"],
                                            "content": content
                                        };
                                        abstract.push(field);
                                    }
                                } else {
                                    var field = {
                                        "field": "",
                                        "content": abstractFull,
                                    }
                                    abstract.push(field);
                                }
                            } else {
                                abstract = [];
                            }
                            var pubdateFull = null;
                            try {
                                pubdateFull = jRes.PubmedArticleSet.PubmedBookArticle.PubmedBookData.History.PubMedPubDate;
                            } catch (error) {
                                pubdateFull = null;
                            }
                            if (pubdateFull != null) {
                                for (i = 0; i < pubdateFull.length; i++) {
                                    if (pubdateFull[i]["@PubStatus"] == "pubmed") {
                                        pubdate = pubdateFull[i]["Day"] + "-" + pubdateFull[i]["Month"] + "-" + pubdateFull[i]["Year"];
                                        break;
                                    } else {
                                        pubdate = null;
                                    }
                                }
                            } else {
                                pubdate = null;
                            }
                            try {
                                book = jRes.PubmedArticleSet.PubmedBookArticle.BookDocument.Book.BookTitle["#text"];
                            } catch (error) {
                                book = null;
                            }
                            var document = {
                                "type": "book",
                                "pmid": pmid,
                                "abstract": abstract,
                                "title": title,
                                "book": book,
                                "pubdate": pubdate,
                            };
                            self.document = document;
                            self.showModal = true;
                        } else if (!_.isUndefined(jRes.PubmedArticleSet.PubmedArticle)) {
                            var title = null;
                            var abstract = [];
                            var pubdate = null;
                            var journal = null;
                            var meshheadings = [];
                            try {
                                title = jRes.PubmedArticleSet.PubmedArticle.MedlineCitation.Article.ArticleTitle;
                            } catch (error) {
                                title = null;
                            }
                            var abstractFull = null;
                            try {
                                abstractFull = jRes.PubmedArticleSet.PubmedArticle.MedlineCitation.Article.Abstract.AbstractText;
                            } catch (error) {
                                abstractFull = null;
                            }
                            if (abstractFull != null) {
                                if (typeof (abstractFull) === "object") {
                                    for (i = 0; i < abstractFull.length; i++) {
                                        var content = abstractFull[i]["#text"];
                                        content = content.replace(/<i>/g, "");
                                        content = content.replace(/<\/i>/g, "");
                                        var field = {
                                            "field": abstractFull[i]["@Label"],
                                            "content": content
                                        };
                                        abstract.push(field);
                                    }
                                } else {
                                    var field = {
                                        "field": "",
                                        "content": abstractFull,
                                    }
                                    abstract.push(field);
                                }
                            } else {
                                abstract = [];
                            }
                            var pubdateFull = null;
                            try {
                                pubdateFull = jRes.PubmedArticleSet.PubmedArticle.PubmedData.History.PubMedPubDate;
                            } catch (error) {
                                pubdateFull = null;
                            }
                            if (pubdateFull != null) {
                                for (i = 0; i < pubdateFull.length; i++) {
                                    if (pubdateFull[i]["@PubStatus"] == "pubmed") {
                                        pubdate = pubdateFull[i]["Day"] + "-" + pubdateFull[i]["Month"] + "-" + pubdateFull[i]["Year"];
                                        break;
                                    } else {
                                        pubdate = null;
                                    }
                                }
                            } else {
                                pubdate = null;
                            }
                            try {
                                journal = jRes.PubmedArticleSet.PubmedArticle.MedlineCitation.Article.Journal.Title;
                            } catch (error) {
                                journal = null;
                            }
                            var meshheadingsFull = null;
                            try {
                                meshheadingsFull = jRes.PubmedArticleSet.PubmedArticle.MedlineCitation.MeshHeadingList.MeshHeading;
                            } catch (error) {
                                meshheadingsFull = null;
                            }
                            if (meshheadingsFull != null) {
                                if (meshheadingsFull.constructor == Object) {
                                    var k = meshheadingsFull["DescriptorName"]["#text"];
                                    meshheadings.push(k);
                                } else if (Array.isArray(meshheadingsFull) && meshheadingsFull.length > 0) {
                                    for (i = 0; i < meshheadingsFull.length; i++) {
                                        var mesh = meshheadingsFull[i]["DescriptorName"]["#text"];
                                        meshheadings.push(mesh);
                                    }
                                } else if (meshheadingsFull === undefined) {
                                    meshheadings = [];
                                }
                            } else {
                                meshheadings = [];
                            }
                            var document = {
                                "type": "article",
                                "pmid": pmid,
                                "abstract": abstract,
                                "title": title,
                                "journal": journal,
                                "pubdate": pubdate,
                                "meshheadings": meshheadings,
                            };
                            self.document = document;
                            self.showModal = true;
                        }
                    }
                });
                request.open("GET", "https://cors-anywhere.herokuapp.com/eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=pubmed&retmode=xml&rettype=medline&id=" + pmid);
                request.send();
            },
            loadSeedDocInfo: function () {
                let self = this;
                let seedDocInfos = [];
                var originalSeed = self.seed;
                var splitedSeed = originalSeed.substring(1, originalSeed.length - 1).split(" ");
                self.seedDocIds = splitedSeed.join(",");
                let request = new XMLHttpRequest();
                request.addEventListener("load", function (ev) {
                    if (ev.currentTarget.status === 200) {
                        let resp = ev.currentTarget.responseXML;
                        var rawValues = resp.querySelectorAll("Item");
                        var tempSeedIds = splitedSeed;
                        for (i = 0; i < rawValues.length; i++) {
                            var seedDocInfo = {};
                            if (rawValues[i].getAttribute("Type") == "String" && rawValues[i].getAttribute("Name") == "Title") {
                                seedDocInfo.title = rawValues[i].innerHTML;
                                seedDocInfo.pmid = tempSeedIds[0];
                                tempSeedIds = tempSeedIds.splice(1);
                                seedDocInfos.push(seedDocInfo);
                            }
                        }
                    }
                    self.seedDocInfos = seedDocInfos;
                });
                request.open("GET", "https://cors-anywhere.herokuapp.com/eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=pubmed&id=" + self.seedDocIds);
                request.send();
            },
            resetMeSHBrowser: function () {
                this.meshInfo = [{rank: 0, id: "", name: "", desc: "", yIntroduced: "", supDate: "", terms: []}];
                this.ids = [];
                this.meshTerm = "";
                this.meshInit = false;
                this.meshReady = false;
                this.meshBusy = false;
                this.page = 1;
                this.perPage = 5;
                this.totalPages = 0;
                this.userDefPerPage = 5;
                this.uDefPage = 1;
                this.meshSearchStart = 0;
                this.meshSearchEnd = 0;
                this.timeSpend = 0;
            },
            loadNextResults: function () {
                let self = this;
                if (!self.busy && !self.finished && self.ready) {
                    self.busy = true;
                    let request = new XMLHttpRequest();
                    request.addEventListener("load", function (ev) {
                        if (ev.currentTarget.status === 200) {
                            let resp = JSON.parse(ev.currentTarget.responseText);
                            if (resp.Finished) {
                                self.finished = true;
                            }
                            for (let i = 0; i < resp.Documents.length; i++) {
                                self.results.push(resp.Documents[i]);
                            }
                            self.start = self.start + resp.Documents.length;
                            self.busy = false;
                        }
                    });
                    request.open("POST", "/api/scroll");
                    request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                    request.send("start=" + self.start + "&query=" + self.textQueryDate + "&lang=" + self.queryLanguage);
                }
            },
            loadResults: function () {
                let self = this;
                let request = new XMLHttpRequest();
                self.ready = false;
                if (!self.busy) {
                    self.busy = true;
                    request.addEventListener("load", function (ev) {
                        if (ev.currentTarget.status === 200) {
                            let resp = JSON.parse(ev.currentTarget.responseText);
                            if (resp.Finished) {
                                self.finished = true;
                            }
                            self.busy = false;
                            self.ready = true;
                            self.init = true;
                            self.results = resp.Documents;
                            self.start = resp.Documents.length;
                            self.total = resp.Total;
                            bb.log(ev, "query", self.textQuery)
                        }
                    });
                    request.open("POST", "/api/scroll");
                    request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                    request.send("start=" + 0 + "&query=" + self.textQueryDate + "&lang=" + self.queryLanguage);
                }
            },
            // This action is triggered after the loadMeSH
            loadMeSHTitles: function (ids) {
                let self = this;
                let meshInfo = [];
                let names = [];
                let descs = [];
                let yIntroduceds = [];
                let supDates = [];
                let entryTerms = [];
                let request = new XMLHttpRequest();
                request.addEventListener("load", function (ev) {
                    if (ev.currentTarget.status === 200) {
                        var xmlDoc = ev.currentTarget.responseXML;
                        var rawValues = xmlDoc.querySelectorAll("Item");
                        for (i = 0; i < rawValues.length; i++) {
                            if (rawValues[i].getAttribute("Type") == "List" && rawValues[i].getAttribute("Name") == "DS_MeshTerms") {
                                names.push(rawValues[i].childNodes[1].innerHTML);
                                var terms = [];
                                for (k = 2; k < rawValues[i].childNodes.length; k++) {
                                    if (rawValues[i].childNodes[k].innerHTML != undefined) {
                                        terms.push(rawValues[i].childNodes[k].innerHTML);
                                    }
                                }
                                entryTerms.push(terms);
                            } else if (rawValues[i].getAttribute("Type") == "String" && rawValues[i].getAttribute("Name") == "DS_ScopeNote") {
                                descs.push(rawValues[i].innerHTML);
                            } else if (rawValues[i].getAttribute("Type") == "Date" && rawValues[i].getAttribute("Name") == "DS_EntryDate") {
                                var tempStr = rawValues[i].innerHTML.toString()
                                var splitStr = tempStr.split(" ")[0];
                                supDates.push(splitStr);
                            } else if (rawValues[i].getAttribute("Type") == "String" && rawValues[i].getAttribute("Name") == "DS_YearIntroduced") {
                                yIntroduceds.push(rawValues[i].innerHTML);
                            }
                        }
                        for (j = 0; j < ids.length; j++) {
                            var temp = {
                                rank: j + 1,
                                id: ids[j],
                                name: names[j],
                                yIntroduced: yIntroduceds[j],
                                desc: descs[j],
                                supDate: supDates[j],
                                terms: entryTerms[j]
                            };
                            meshInfo.push(temp);
                        }
                        self.meshInfo = meshInfo;
                    }
                    self.meshInit = true;
                    self.meshReady = true;
                    self.meshBusy = false;
                    self.meshSearchEnd = new Date().getTime();
                    self.timeSpend = (self.meshSearchEnd - self.meshSearchStart) / 1000;
                });
                request.open("GET", "https://cors-anywhere.herokuapp.com/eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=mesh&sort=relevance" + "&id=" + self.ids.toString());
                request.send();
            },
            // load MeSH IDs and save for later processing then load MeSH Term information by calling loadMeSHTitles
            loadMeSH: function (e) {
                if ((e != undefined && e.keyCode === 13) || e === undefined) {
                    let self = this;
                    let request = new XMLHttpRequest();
                    self.meshBusy = true;
                    self.meshReady = false;
                    self.ids = [];
                    self.meshInfo = [{rank: 0, id: "", name: "", desc: "", yIntroduced: "", supDate: "", terms: []}];
                    self.page = 1;
                    self.uDefPage = 1;
                    self.totalPages = 0;
                    self.meshInit = false;
                    self.meshSearchStart = new Date().getTime();
                    request.addEventListener("load", function (ev) {
                        let ids = [];
                        if (ev.currentTarget.status === 200) {
                            var xmlDoc = ev.currentTarget.responseXML;
                            let rawValues = xmlDoc.getElementsByTagName("Id");
                            for (i = 0; i < rawValues.length; i++) {
                                ids[i] = rawValues[i].childNodes[0].nodeValue;
                            }
                        } else {
                            ids = [0];
                            self.meshInit = false;
                        }
                        self.ids = ids;
                        self.loadMeSHTitles(ids);
                    });
                    // Set retmax to 9999999 simply to avoid another unneccessary API call to get the correct count
                    request.open("GET", "https://cors-anywhere.herokuapp.com/eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=mesh" + "&sort=relevance&term=" + self.meshTerm + "&retmax=9999999");
                    request.send();
                }
            },
            changeNumOfTermsPerPage: function (e) {
                if ((e != undefined && e.keyCode === 13) || e === undefined) {
                    let self = this;
                    if (/^\d+$/.test(self.userDefPerPage)) {
                        if (self.userDefPerPage === '' || parseInt(self.userDefPerPage) === 0 || parseInt(self.userDefPerPage) < 0) {
                            self.perPage = 10;
                        } else {
                            self.perPage = parseInt(self.userDefPerPage);
                        }
                    } else {
                        self.perPage = 10;
                    }
                    self.page = 1;
                    self.uDefPage = 1;
                }
            },
            // Create pagination
            paginate: function (meshInfo) {
                let self = this;
                let page = self.page;
                self.totalPages = Math.ceil(meshInfo.length / self.perPage);
                let perPage = self.perPage;
                let from = (page * perPage) - perPage;
                let to = (page * perPage);
                return meshInfo.slice(from, to);
            }
        },
        beforeMount: function () {
            this.getHistory();
            this.loadSeedDocInfo();
        },
        watch: {
            // Do not continue to update the log when we are not in the console tab.
            cqrQuery: function () {
                this.updateText()
            }
        }
    })
</script>

<!-- Tree view. -->
<script src="/static/vis.min.js" type="text/javascript"></script>
<script type="text/javascript">
    // create an array with nodes
    var nodes = new vis.DataSet([]);

    // create an array with edges
    var edges = new vis.DataSet([]);

    // create a network
    var container = document.getElementById('tree');

    // provide the data in the vis format
    var data = {
        nodes: nodes,
        edges: edges
    };
    var options = {
        interaction: {
            navigationButtons: true
        },
        physics: {
            enabled: true,
            hierarchicalRepulsion: {
                nodeDistance: 300,
            },
            repulsion: {
                nodeDistance: 800,
                springLength: 200,
                centralGravity: 0.01,
                springConstant: 0.1,
                damping: 0.2
            },
            barnesHut: {
                gravitationalConstant: -80000,
                springLength: 100,
                springConstant: 0.01,
                centralGravity: 0.2,
                damping: 1,
            },
            solver: 'barnesHut'
        },
        edges: {
            font: {
                align: "top"
            },
            smooth: {
                enabled: true,
                type: "dynamic"
            },
            scaling: {
                label: {
                    enabled: true,
                    min: 25,
                    max: 30
                }
            }
        },
        nodes: {
            shape: "box",
            color: "#CED2FF",
            font: {
                color: "#333333"
            },
            scaling: {
                customScalingFunction: function (min, max, total, value) {
                    return value / total;
                },
                min: 60,
                max: 100,
                label: {
                    enabled: true,
                    min: 25,
                    max: 30
                }
            },
            widthConstraint: true
        },
        layout: {
            hierarchical: {
                enabled: true,
                blockShifting: false,
                edgeMinimization: true,
                parentCentralization: true,
                nodeSpacing: 10,
                levelSeparation: 250
            }
        }
    };

    // initialize your network!
    var network = new vis.Network(container, data, options);
</script>
</body>
</html>