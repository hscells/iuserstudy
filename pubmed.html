<!DOCTYPE html>
<!--suppress ALL -->
<html lang="en" xmlns:v-on="http://www.w3.org/1999/xhtml" xmlns:v-bind="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>searchrefiner - QueryVis</title>
    <link rel="icon" href="static/favicon.png" type="image/x-png">
    <link rel="stylesheet" href="/static/spectre.min.css" type="text/css">
    <link rel="stylesheet" href="/static/spectre-icons.min.css" type="text/css">
    <link rel="stylesheet" href="/static/spectre-exp.min.css" type="text/css">
    <link rel="stylesheet" href="/static/vis.min.css" type="text/css">
    <link rel="stylesheet" href="/static/vue-multiselect.min.css" type="text/css">
    <link rel="stylesheet" href="/static/logtail.css" type="text/css">
    <link rel="stylesheet" href="/static/searchrefiner.css" type="text/css">
</head>
<body>
<script type="text/javascript" src="/static/bigbro.js"></script>
<script type="text/javascript">
    let bb = BigBro.init({{.UID}}, window.location.host + "/plugin/iuserstudy?bigbro");
    window.addEventListener("load", function (e) {
        bb.log(e, "pageload", "{{.UID}}")
    })
</script>
<div class="container" id="app">
    <header class="navbar bg-secondary nav-height">
        <section class="navbar-section"><a href="?uid={{.UID}}"><i class="icon icon-arrow-left"></i>back</a></section>
        <section class="navbar-section">Participant ID:<span class="label label-primary mr-1 ml-1">{{.UID}}</span></section>
    </header>
    <div class="columns">
        <div class="column col-1"></div>
        <div class="column col-10">
            <div class="form-group">
                <pre name="query" class="code" id="search-box">[[ textQuery ]]</pre>
                <input type="hidden" name="lang" value="pubmed">
            </div>
            {{/*<a href="#">Edit</a>*/}}
            <div class="panel p-2">
                <div class="panel-header">
                    <b>Query Builder</b>
                </div>
                <div class="panel-body">
                    <builder v-for="(query, index) in queries"
                             :key="query.id"
                             v-on:add="addQuery"
                             v-on:remove="removeQuery"
                             v-bind:query="query"
                             v-bind:index="index"
                             v-bind:last="index==queries.length-1"></builder>
                    <a href="#" v-on:click="clear">Clear</a>
                </div>
                <div class="panel-footer">
                    <button class="btn btn-primary nav-height float-right" id="btn-update-tree" v-on:click="loadResults">
                        <i class="icon icon-forward"></i> Results
                    </button>
                </div>
            </div>
            <div class="columns">
                <div class="column col-6">
                    <div class="panel p-2 mt-2">
                        <div class="panel-header">
                            <b>Seed documents</b>
                        </div>
                        <div class="panel-body">
                            <ul>
                                {{range .Seed }}
                                    <li><a href="https://www.ncbi.nlm.nih.gov/pubmed/{{ . }}" target="_blank">{{ . }}</a></li>
                                {{end}}
                            </ul>
                        </div>
                    </div>
                    <div class="panel p-2 mt-2">
                        <div class="panel-header">
                            <b>History</b>
                        </div>
                        <div class="panel-body container">
                            <div class="columns">
                                <div class="column col-8 text-italic">Query</div>
                                <div class="column col-2 text-italic">Items found</div>
                            </div>
                            <div class="divider"></div>
                            <div v-for="query in history">
                                <div class="columns">
                                    <div class="column col-8">[[ query.QueryString ]]</div>
                                    <div class="column col-2">[[ query.NumRet ]]</div>
                                </div>
                                <div class="divider"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="column col-6">
                    <div class="panel p-2 mt-2">
                        <div class="panel-header">
                            <b>Results: </b><span>([[ total ]])</span>
                        </div>
                        <div class="panel-body" style="overflow: hidden">
                            <div v-if="busy && !ready" class="loading loading-lg"></div>
                            <p v-if="!init">Results will show here once you click the button above.</p>
                            <ol v-infinite-scroll="loadNextResults" infinite-scroll-disabled="busy" infinite-scroll-distance="10">
                                <li v-for="c in results" class="pb-2">
                                    <a v-bind:href="'https://www.ncbi.nlm.nih.gov/pubmed/' + c.PMID">[[c.TI]]</a>
                                    <div class="text-left text-sm">
                                        <a v-for="author in c.AU" class="text-success author-sm"
                                           v-bind:href="'https://www.ncbi.nlm.nih.gov/pubmed/?term=%22' + author + '%22[Author]'">[[author]]</a>&nbsp;
                                    </div>
                                    <div class="text-left text-sm text-gray">
                                        <span class="span-sm"><strong>PMID</strong>: [[ c.PMID ]]</span>
                                    </div>
                                </li>
                            </ol>
                            <div v-if="busy && ready" class="loading loading-lg"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="column col-1"></div>
    </div>
</div>

<script type="text/x-template" id="builder">
    <div class="columns">
        <div class="column col-2">
            <select class="form-select select-sm" v-if="index>0" v-model="query.operator" v-bind:field="query.operator" v-on:change="updateCQR">
                <option value="and">AND</option>
                <option value="or">OR</option>
                <option value="not">NOT</option>
            </select>
        </div>
        <div class="column col-3">
            <select class="form-select select-sm" v-model="query.field" v-bind:field="query.field" v-on:change="updateCQR">
                <option value="Affiliation">Affiliation</option>
                <option value="All Fields" selected="selected">All Fields</option>
                <option value="Author">Author</option>
                <option value="Author - Corporate">Author - Corporate</option>
                <option value="Author - First">Author - First</option>
                <option value="Author - Full">Author - Full</option>
                <option value="Author - Identifier">Author - Identifier</option>
                <option value="Author - Last">Author - Last</option>
                <option value="Book">Book</option>
                <option value="Conflict of Interest Statements">Conflict of Interest Statements</option>
                <option value="Date - Completion">Date - Completion</option>
                <option value="Date - Create">Date - Create</option>
                <option value="Date - Entrez">Date - Entrez</option>
                <option value="Date - MeSH">Date - MeSH</option>
                <option value="Date - Modification">Date - Modification</option>
                <option value="Date - Publication">Date - Publication</option>
                <option value="EC/RN Number">EC/RN Number</option>
                <option value="Editor">Editor</option>
                <option value="Filter">Filter</option>
                <option value="Grant Number">Grant Number</option>
                <option value="ISBN">ISBN</option>
                <option value="Investigator">Investigator</option>
                <option value="Investigator - Full">Investigator - Full</option>
                <option value="Issue">Issue</option>
                <option value="Journal">Journal</option>
                <option value="Language">Language</option>
                <option value="Location ID">Location ID</option>
                <option value="MeSH Major Topic">MeSH Major Topic</option>
                <option value="MeSH Subheading">MeSH Subheading</option>
                <option value="MeSH Terms">MeSH Terms</option>
                <option value="Other Term">Other Term</option>
                <option value="Pagination">Pagination</option>
                <option value="Pharmacological Action">Pharmacological Action</option>
                <option value="Publication Type">Publication Type</option>
                <option value="Publisher">Publisher</option>
                <option value="Secondary Source ID">Secondary Source ID</option>
                <option value="Subject - Personal Name">Subject - Personal Name</option>
                <option value="Supplementary Concept">Supplementary Concept</option>
                <option value="Text Word">Text Word</option>
                <option value="Title">Title</option>
                <option value="Title/Abstract">Title/Abstract</option>
                <option value="Transliterated Title">Transliterated Title</option>
                <option value="Volume">Volume</option>
            </select>
        </div>
        <div class="column col-5">
            <input type="text" v-model="query.query" v-bind:query="query.query" v-on:keyup="updateCQR" class="form-input input-sm"/>
        </div>
        <div class="column col-2">
            <div class="btn-group">
                <a href="#" class="btn btn-action btn-sm" v-on:click="removeSelf"><i class="icon icon-minus"></i></a>
                <a href="#" class="btn btn-action btn-sm" v-if="last" v-on:click="addQuery"><i class="icon icon-plus"></i></a>
            </div>
        </div>
    </div>
</script>

<!-- Main app code. -->
<script src="/static/vue.js" type="text/javascript"></script>
<script src="/static/vue-infinite-scroll.js" type="text/javascript"></script>
<script type="text/javascript" src="/static/lodash.min.js"></script>
<script src="/static/Sortable.min.js"></script>
<script src="/static/vuedraggable.min.js"></script>
<!--suppress JSUnusedGlobalSymbols -->
<script>
    var structuredID = 0;
    Vue.component("builder", {
        delimiters: ["[[", "]]"],
        template: "#builder",
        props: ["index", "last", "query"],
        data: function () {
            return {
                id: structuredID++,
            }
        },
        beforeMount: function () {
            this.updateCQR();
        },
        methods: {
            removeSelf: function () {
                this.$emit("remove", this.$props.index);
            },
            addQuery: function () {
                this.$emit("add", {query: "", fields: ["All Fields"], operator: "and", cqr: {}, field: "All Fields"})
            },
            updateCQR: function () {
                if (this.$props.query.query.length === 0) {
                    this.$props.query.cqr = {query: "", fields: [this.$props.query.field]}
                    return
                }
                var self = this;
                var request = new XMLHttpRequest();
                request.addEventListener("load", function (ev) {
                    if (ev.currentTarget.status === 200) {
                        self.$props.query.cqr = JSON.parse(ev.currentTarget.responseText)
                        self.$props.query.cqr = fixNilFields(self.$props.query.cqr, self.$props.query.field)
                    }
                });
                request.open("POST", "/api/query2cqr");
                request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                request.send("query=" + self.query.query + "&lang=pubmed&field=" + self.query.field);
            }
        }
    });

    fixNilFields = function (query, field) {
        if (query.children !== undefined && query.children.length > 0) {
            for (var i = 0; i < query.children.length; i++) {
                query.children[i] = fixNilFields(query.children[i], field)
            }
        } else if (query.fields[0] === "nil") {
            query.fields[0] = field
        }
        return query
    }

    var vm = new Vue({
        delimiters: ["[[", "]]"],
        el: "#app",
        data: {
            results: [],
            total: 0,
            busy: false,
            ready: false,
            finished: false,
            init: false,
            start: 0,

            numRet: 0,
            numRel: 0,
            numRelRet: 0,
            textQuery: "Use the Query Builder below to formulate your query. It will show here afterwards.",
            queryLanguage: "{{.Language}}",
            queries: [{query: "", field: "All Fields", operator: "", cqr: {}}, {query: "", field: "All Fields", operator: "and", cqr: {}}],
            history: [],
        },
        computed: {
            cqrQuery() {
                var q = {};
                for (var i = 0; i < this.queries.length; i++) {
                    var child = {}
                    if (!Object.keys(this.queries[i].cqr).length) {
                        child = {
                            query: this.queries[i].query,
                            fields: [this.queries[i].field],
                        }
                    } else {
                        child = this.queries[i].cqr;
                        if (child === undefined || child.operator == "") {
                            child = {
                                query: this.queries[i].query,
                                fields: [this.queries[i].field],
                            }
                        }
                    }

                    // Skip adding this child because it is empty.
                    if (child.operator === undefined && (child.query === null || child.query === undefined || child.query.length === 0)) {
                        continue
                    }

                    // Add the child underneath the current query.
                    if (!Object.keys(q).length) {
                        q = child
                    } else {
                        q = {
                            operator: this.queries[i].operator,
                            children: [
                                child,
                                q
                            ]
                        }
                    }
                }
                return JSON.stringify(q)
            }
        },
        methods: {
            removeQuery: function (index) {
                this.queries.splice(index, 1)
                if (this.queries.length == 0) {
                    this.queries.push({query: ""})
                }
            },
            addQuery: function (query) {
                this.queries.push(query)
            },
            getHistory: function () {
                {
                    var self = this;
                    var request = new XMLHttpRequest();
                    request.addEventListener("load", function (ev) {
                        self.history = JSON.parse(ev.target.responseText);
                    });
                    request.open("GET", "/api/history", true);
                    request.send()
                }
            },
            updateText: _.debounce(function () {
                var self = this;
                var request = new XMLHttpRequest();
                request.addEventListener("load", function (ev) {
                    if (ev.currentTarget.status === 200) {
                        self.textQuery = ev.currentTarget.responseText
                    }
                });
                request.open("POST", "/api/cqr2query");
                request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                request.send("query=" + self.cqrQuery + "&lang=" + self.queryLanguage);
            }, 300),
            clear: function () {
                this.queries = [{query: "", field: "All Fields", operator: "", cqr: {}}, {query: "", field: "All Fields", operator: "and", cqr: {}}];
            },
            loadNextResults: function () {
                let self = this;
                if (!self.busy && !self.finished && self.ready) {
                    self.busy = true;
                    let request = new XMLHttpRequest();
                    request.addEventListener("load", function (ev) {
                        if (ev.currentTarget.status === 200) {
                            let resp = JSON.parse(ev.currentTarget.responseText);
                            for (let i = 0; i < resp.Documents.length; i++) {
                                self.results.push(resp.Documents[i]);
                            }
                            self.start = self.start + resp.Documents.length;
                            self.busy = false;
                        }
                    });
                    request.open("POST", "/api/scroll");
                    request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                    request.send("start=" + self.start + "&query=" + self.textQuery + "&lang=" + self.queryLanguage);
                }
            },
            loadResults: function () {
                let self = this;
                let request1 = new XMLHttpRequest();
                let request = new XMLHttpRequest();
                self.ready = false;
                if (!self.busy) {
                    request1.addEventListener("load", function (ev) {
                        if (ev.currentTarget.status === 200) {
                            self.getHistory();
                        }
                    });
                    request1.open("POST", "/api/history");
                    request1.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                    request1.send("query=" + self.textQuery + "&lang=" + self.queryLanguage);

                    self.busy = true;
                    request.addEventListener("load", function (ev) {
                        if (ev.currentTarget.status === 200) {
                            let resp = JSON.parse(ev.currentTarget.responseText);
                            if (resp.Finished) {
                                self.finished = true;
                            }
                            self.busy = false;
                            self.ready = true;
                            self.init = true;
                            self.results = resp.Documents;
                            self.start = resp.Documents.length;
                            self.total = resp.Total;
                            bb.log(ev, "query", self.textQuery)
                        }
                    });
                    request.open("POST", "/api/scroll");
                    request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                    request.send("start=" + 0 + "&query=" + self.textQuery + "&lang=" + self.queryLanguage);
                }
            }
        },
        beforeMount: function () {
            this.getHistory()
        },
        watch: {
            // Do not continue to update the log when we are not in the console tab.
            cqrQuery: function () {
                this.updateText()
            }
        }
    })
</script>
</body>
</html>